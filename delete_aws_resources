import boto3
from botocore.exceptions import ClientError

# Define the names of resources to delete
BUCKET_PREFIX = "sports-analytics-data-lake"
GLUE_DATABASE_NAME = "glue_nba_data_lake"

def find_project_buckets():
    """Find all buckets with the sports-analytics-data-lake prefix."""
    s3 = boto3.client("s3")
    try:
        response = s3.list_buckets()
        project_buckets = []
        for bucket in response['Buckets']:
            if bucket['Name'].startswith(BUCKET_PREFIX):
                project_buckets.append(bucket['Name'])
        return project_buckets
    except ClientError as e:
        print(f"Error listing buckets: {e}")
        return []

def delete_athena_query_results(bucket_name):
    """Delete Athena query results stored in the specified S3 bucket."""
    s3 = boto3.client("s3")
    try:
        print(f"Deleting Athena query results in bucket: {bucket_name}")
        objects = s3.list_objects_v2(Bucket=bucket_name, Prefix="athena-results/")
        if "Contents" in objects:
            for obj in objects["Contents"]:
                s3.delete_object(Bucket=bucket_name, Key=obj["Key"])
                print(f"Deleted Athena query result: {obj['Key']}")
    except ClientError as e:
        print(f"Error deleting Athena query results in bucket {bucket_name}: {e}")

def delete_s3_bucket(bucket_name):
    """Delete a specific S3 bucket and its contents."""
    s3 = boto3.client("s3")
    try:
        print(f"Deleting bucket: {bucket_name}")
        # Delete all objects in the bucket
        objects = s3.list_objects_v2(Bucket=bucket_name)
        if "Contents" in objects:
            for obj in objects["Contents"]:
                s3.delete_object(Bucket=bucket_name, Key=obj["Key"])
                print(f"Deleted object: {obj['Key']}")
        # Delete the bucket
        s3.delete_bucket(Bucket=bucket_name)
        print(f"Deleted bucket: {bucket_name}")
    except ClientError as e:
        print(f"Error deleting bucket {bucket_name}: {e}")

def delete_glue_resources(database_name):
    """Delete Glue database and associated tables."""
    glue = boto3.client("glue")
    try:
        print(f"Deleting Glue database: {database_name}")
        # Get tables in the database
        tables = glue.get_tables(DatabaseName=database_name)["TableList"]
        for table in tables:
            table_name = table["Name"]
            print(f"Deleting Glue table: {table_name} in database {database_name}")
            glue.delete_table(DatabaseName=database_name, Name=table_name)
        # Delete the database
        glue.delete_database(Name=database_name)
        print(f"Deleted Glue database: {database_name}")
    except ClientError as e:
        print(f"Error deleting Glue resources for database {database_name}: {e}")

def main():
    print("Deleting resources created during data lake setup...")
    
    # Find and delete all project buckets
    project_buckets = find_project_buckets()
    if project_buckets:
        print(f"Found {len(project_buckets)} project bucket(s): {project_buckets}")
        for bucket_name in project_buckets:
            delete_s3_bucket(bucket_name)
    else:
        print("No project buckets found to delete.")
    
    # Delete Glue resources
    delete_glue_resources(GLUE_DATABASE_NAME)
    
    print("Cleanup complete.")

if __name__ == "__main__":
    main()
